{% extends "base.html" %}

{% block title %}Spending Breakdown{% endblock %}
{% block page_title %}Spending Breakdown{% endblock %}

{% block header_actions %}
<a href="/moneypit/heatmap/months{% if ts_start or ts_end %}?{% if ts_start %}ts_start={{ ts_start }}{% endif %}{% if ts_start and ts_end %}&{% endif %}{% if ts_end %}ts_end={{ ts_end }}{% endif %}{% endif %}"
   class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
          border border-gray-700 text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
  <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
  </svg>
  Heatmap
</a>
{% endblock %}

{% block head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{% endblock %}

{% block content %}

<!-- Date range bar -->
<div class="mb-5">
  <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
    <div class="flex items-center gap-2 text-sm text-gray-400">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
      <span class="text-gray-200 font-medium">{{ date_start }}</span>
      <span>to</span>
      <span class="text-gray-200 font-medium">{{ date_end }}</span>
      <span class="ml-3 text-gray-500">â€¢</span>
      <span class="ml-1 text-gray-400">Total tracked: <span class="text-gray-200 font-semibold">${{ "{:,.2f}".format(total_spend) }}</span></span>
    </div>

    <!-- Date range filter form -->
    <form method="get" action="/moneypit/graphs"
          class="flex items-center gap-2">
      <label class="text-xs text-gray-500 uppercase tracking-wide">From</label>
      <input type="month" name="ts_start" value="{{ ts_start }}"
             class="bg-gray-800 border border-gray-700 text-gray-200 text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent">
      <label class="text-xs text-gray-500 uppercase tracking-wide">To</label>
      <input type="month" name="ts_end" value="{{ ts_end }}"
             class="bg-gray-800 border border-gray-700 text-gray-200 text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent">
      <button type="submit"
              class="px-3 py-1.5 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-lg transition-colors">
        Apply
      </button>
    </form>
  </div>

  <!-- Graph picker -->
  <div class="flex items-center gap-2 mb-3">
    <span class="text-xs text-gray-500 uppercase tracking-wide mr-2">Graph:</span>
    <button type="button" id="graph-bar" class="graph-picker px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors bg-brand-600 border-brand-500 text-white">
      Bar
    </button>
    <button type="button" id="graph-stacked" class="graph-picker px-3 py-1.5 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors">
      Stacked over time
    </button>
  </div>

  <!-- Quick preset buttons -->
  <div class="flex items-center gap-2 flex-wrap">
    <span class="text-xs text-gray-500 uppercase tracking-wide mr-1">Quick:</span>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-months="0">This month</button>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-months="-1">Last month</button>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-months="-3">Last 3 months</button>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-months="-6">Last 6 months</button>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-months="-12">Last year</button>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-preset="this-year">This year</button>
  </div>
</div>

<!-- Bar chart (sorted by amount, descending) -->
<div class="bg-gray-900 rounded-xl border border-gray-800 shadow-lg p-4">
  <div id="breakdown-chart" style="min-height: 800px;"></div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const raw = {{ sankey_data | safe }};
  const timeSeriesRaw = {{ time_series_data | safe }};

  // Pair categories with amounts (nodes[0] is "Total Spend", nodes[1..] are categories)
  const pairs = raw.nodes.slice(1).map((cat, i) => [cat, raw.values[i]]);
  pairs.sort((a, b) => b[1] - a[1]);  // Descending by amount

  const categories = pairs.map(p => p[0]);
  const amounts = pairs.map(p => p[1]);

  const palette = [
    '#f97316', '#fb923c', '#fbbf24', '#a3e635', '#34d399',
    '#22d3ee', '#38bdf8', '#818cf8', '#c084fc', '#f472b6',
    '#fb7185', '#e879f9', '#67e8f9', '#86efac', '#fde68a',
    '#fdba74', '#d8b4fe', '#a5b4fc', '#6ee7b7', '#fca5a5',
  ];

  const config = { displayModeBar: false, responsive: true };

  function renderBarChart() {
    const data = [{
      type: 'bar',
      orientation: 'h',
      x: amounts,
      y: categories,
      marker: {
        color: categories.map((_, i) => palette[i % palette.length]),
        line: { color: 'rgba(255,255,255,0.15)', width: 1 },
      },
      text: amounts.map(a => '$' + a.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })),
      textposition: 'outside',
      textfont: { color: '#94a3b8', size: 12 },
      hovertemplate: '<b>%{y}</b><br>$%{x:,.2f}<extra></extra>',
    }];

    const layout = {
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor:  'rgba(0,0,0,0)',
      font: { family: 'ui-sans-serif, system-ui, sans-serif', size: 13, color: '#e2e8f0' },
      margin: { l: 140, r: 80, t: 20, b: 40 },
      xaxis: {
        gridcolor: 'rgba(255,255,255,0.06)',
        zerolinecolor: 'rgba(255,255,255,0.1)',
        tickformat: '$,.0f',
        title: '',
      },
      yaxis: {
        autorange: 'reversed',
        gridcolor: 'transparent',
        tickfont: { size: 12 },
      },
      bargap: 0.35,
      showlegend: false,
    };

    Plotly.newPlot('breakdown-chart', data, layout, config);
  }

  function renderStackedAreaChart() {
    const months = timeSeriesRaw.months || [];
    const cats = timeSeriesRaw.categories || [];
    const dataObj = timeSeriesRaw.data || {};

    if (months.length === 0 || cats.length === 0) {
      Plotly.newPlot('breakdown-chart', [{ type: 'scatter', x: [], y: [], mode: 'lines' }], {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'ui-sans-serif, system-ui, sans-serif', size: 13, color: '#e2e8f0' },
        margin: { l: 60, r: 40, t: 20, b: 60 },
        xaxis: { gridcolor: 'rgba(255,255,255,0.06)', zerolinecolor: 'rgba(255,255,255,0.1)' },
        yaxis: { gridcolor: 'rgba(255,255,255,0.06)', zerolinecolor: 'rgba(255,255,255,0.1)', tickformat: '$,.0f' },
      }, config);
      return;
    }

    // Plotly stacked area: each trace is fill: 'tonexty', stackgroup: 'one'
    const traces = cats.map((cat, i) => ({
      type: 'scatter',
      x: months,
      y: dataObj[cat] || months.map(() => 0),
      name: cat,
      mode: 'lines',
      line: { width: 0.5, color: palette[i % palette.length] },
      fill: 'tonexty',
      stackgroup: 'one',
    }));

    const layout = {
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor:  'rgba(0,0,0,0)',
      font: { family: 'ui-sans-serif, system-ui, sans-serif', size: 13, color: '#e2e8f0' },
      margin: { l: 60, r: 40, t: 20, b: 80 },
      xaxis: {
        gridcolor: 'rgba(255,255,255,0.06)',
        zerolinecolor: 'rgba(255,255,255,0.1)',
        tickangle: -45,
        tickfont: { size: 11 },
      },
      yaxis: {
        gridcolor: 'rgba(255,255,255,0.06)',
        zerolinecolor: 'rgba(255,255,255,0.1)',
        tickformat: '$,.0f',
        title: 'Spending',
      },
      legend: {
        orientation: 'h',
        y: 1.15,
        yanchor: 'bottom',
        font: { size: 11 },
      },
      hovermode: 'x unified',
    };

    Plotly.newPlot('breakdown-chart', traces, layout, config);
  }

  // Graph picker
  let currentGraph = 'bar';
  document.getElementById('graph-bar').addEventListener('click', function() {
    if (currentGraph === 'bar') return;
    currentGraph = 'bar';
    document.getElementById('graph-bar').className = 'graph-picker px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors bg-brand-600 border-brand-500 text-white';
    document.getElementById('graph-stacked').className = 'graph-picker px-3 py-1.5 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors';
    renderBarChart();
  });
  document.getElementById('graph-stacked').addEventListener('click', function() {
    if (currentGraph === 'stacked') return;
    currentGraph = 'stacked';
    document.getElementById('graph-stacked').className = 'graph-picker px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors bg-brand-600 border-brand-500 text-white';
    document.getElementById('graph-bar').className = 'graph-picker px-3 py-1.5 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors';
    renderStackedAreaChart();
  });

  renderBarChart();

  // Quick date presets
  document.querySelectorAll('.date-preset').forEach(btn => {
    btn.addEventListener('click', function() {
      const preset = this.dataset.preset;
      let tsStart, tsEnd;
      if (preset === 'this-year') {
        const y = new Date().getFullYear();
        tsStart = y + '-01';
        tsEnd = (y + 1) + '-01';
      } else {
        const months = parseInt(this.dataset.months, 10);
        const now = new Date();
        const startOffset = (months < 0 && months !== -1) ? months + 1 : months;
        const start = new Date(now.getFullYear(), now.getMonth() + startOffset, 1);
        const end = months === -1
          ? new Date(now.getFullYear(), now.getMonth(), 1)
          : new Date(now.getFullYear(), now.getMonth() + 1, 1);
        const fmt = d => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
        tsStart = fmt(start);
        tsEnd = fmt(end);
      }
      const params = new URLSearchParams({ ts_start: tsStart, ts_end: tsEnd });
      window.location = '/moneypit/graphs?' + params;
    });
  });
</script>
{% endblock %}
