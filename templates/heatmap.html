{% extends "base.html" %}

{% block title %}Heatmap{% endblock %}
{% block page_title %}Monthly Spending Heatmap{% endblock %}

{% block header_actions %}
<a href="/moneypit/sankey"
   class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
          border border-gray-700 text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
  <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M7 16V4m0 0L3 8m4-4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/>
  </svg>
  Breakdown
</a>
<a href="/moneypit/heatmap/months?core_expenses={{ core_expense_qualifier }}"
   class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
          border border-gray-700 text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
  {% if core_expense_qualifier == "Exclude" %}
    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
    </svg>
    Exclude Core Expenses
  {% else %}
    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
    </svg>
    Include Core Expenses
  {% endif %}
</a>
{% endblock %}

{% block content %}
<!-- Date range bar -->
<div class="mb-5" data-core-expenses="{{ 'Exclude' if core_expense_qualifier == 'Exclude' else '' }}">
  <div class="flex items-center justify-between mb-3">
    <div class="flex items-center gap-2 text-sm text-gray-400">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
      <span class="text-gray-200 font-medium">{{ date_start }}</span>
      <span>to</span>
      <span class="text-gray-200 font-medium">{{ date_end }}</span>
    </div>

    <!-- Date range filter form -->
    <form method="get" action="/moneypit/heatmap/months"
          class="flex items-center gap-2">
      <input type="hidden" name="core_expenses"
             value="{{ 'Exclude' if core_expense_qualifier == 'Include' else '' }}">
      <label class="text-xs text-gray-500 uppercase tracking-wide">From</label>
    <input type="month" name="ts_start" value="{{ ts_start }}"
           class="bg-gray-800 border border-gray-700 text-gray-200 text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent">
    <label class="text-xs text-gray-500 uppercase tracking-wide">To</label>
    <input type="month" name="ts_end" value="{{ ts_end }}"
           class="bg-gray-800 border border-gray-700 text-gray-200 text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent">
      <button type="submit"
              class="px-3 py-1.5 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-lg transition-colors">
        Apply
      </button>
    </form>
  </div>

  <!-- Preset buttons -->
  <div class="flex items-center gap-2 flex-wrap">
    <span class="text-xs text-gray-500 uppercase tracking-wide mr-1">Quick:</span>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-months="0">This month</button>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-months="-1">Last month</button>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-months="-3">Last 3 months</button>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-months="-6">Last 6 months</button>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-months="-12">Last year</button>
    <button type="button" class="date-preset px-2.5 py-1 text-xs font-medium rounded-lg border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 transition-colors" data-preset="this-year">This year</button>
  </div>
</div>

<!-- Income / Expenses / Total summary table -->
<div class="bg-gray-900 rounded-xl border border-gray-800 shadow-lg overflow-hidden mb-5">
  <div class="px-5 py-3 border-b border-gray-800">
    <h3 class="text-sm font-semibold text-gray-200">Summary</h3>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-gray-800">
          <th class="text-left px-5 py-2.5 text-xs font-semibold text-gray-400 uppercase tracking-wide w-28"></th>
          {% for date_key in heatmap_data_container.get_dates() %}
          <th class="text-center px-4 py-2.5 text-xs font-semibold text-gray-400 uppercase tracking-wide">
            <a href="/moneypit/heatmap/months?ts_start={{ date_key }}&ts_end={{ date_key | add_month_filter }}{% if core_expenses_param %}&core_expenses={{ core_expenses_param }}{% endif %}"
               class="cursor-pointer text-gray-300 hover:text-white hover:underline transition-colors">{{ date_key }}</a>
          </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-800/60">
        <tr class="hover:bg-gray-800/30">
          <td class="px-5 py-2.5 text-emerald-400 font-semibold">Income</td>
          {% for date_key in heatmap_data_container.get_dates() %}
          <td class="px-4 py-2.5 text-center text-emerald-400 font-semibold">
            {{ heatmap_data_container.get_total_for_date(date_key, only_positive=True) }}
          </td>
          {% endfor %}
        </tr>
        <tr class="hover:bg-gray-800/30">
          <td class="px-5 py-2.5 text-rose-400 font-semibold">Expenses</td>
          {% for date_key in heatmap_data_container.get_dates() %}
          <td class="px-4 py-2.5 text-center text-rose-400 font-semibold">
            {{ heatmap_data_container.get_total_for_date(date_key, only_negative=True) }}
          </td>
          {% endfor %}
        </tr>
        <tr class="border-t-2 border-gray-700 bg-gray-800/30">
          <td class="px-5 py-2.5 text-gray-100 font-bold">Total</td>
          {% for date_key in heatmap_data_container.get_dates() %}
          <td class="px-4 py-2.5 text-center font-bold text-gray-100">
            {{ heatmap_data_container.get_total_for_date(date_key) }}
          </td>
          {% endfor %}
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Heatmap table (categories only) -->
<div class="bg-gray-900 rounded-xl border border-gray-800 shadow-lg overflow-hidden">
  <div class="px-5 py-3 border-b border-gray-800">
    <h3 class="text-sm font-semibold text-gray-200">Spending by Category</h3>
  </div>
  <div class="heatmap-wrapper">
    <table class="heatmap-table w-full" id="heatmap-table">
      <thead>
        <tr>
          <th class="text-left">Category</th>
          {% for date_key in heatmap_data_container.get_dates() %}
          <th>
            <a href="/moneypit/heatmap/months?ts_start={{ date_key }}&ts_end={{ date_key | add_month_filter }}{% if core_expenses_param %}&core_expenses={{ core_expenses_param }}{% endif %}"
               class="cursor-pointer text-gray-300 hover:text-white hover:underline transition-colors block">{{ date_key }}</a>
          </th>
          {% endfor %}
          <th class="text-center heatmap-total-col cursor-pointer select-none hover:bg-gray-800/50 transition-colors" id="heatmap-total-header" title="Click to sort">
            Total <span id="sort-indicator" class="text-brand-400">↓</span>
          </th>
        </tr>
      </thead>
      <tbody id="heatmap-tbody">
      {% for cat in categories %}
      {% set row_total = heatmap_data_container.get_row_total(cat) %}
      <tr data-total="{{ row_total }}">
        <td class="text-gray-300">{{ cat }}</td>
        {% for date_key in heatmap_data_container.get_dates() %}
          {% set rgb = heatmap_data_container.get_rgb(date_key, cat) %}
          {% set val = heatmap_data_container.get_value(date_key, cat) %}
          <td class="color-cell {% if val == 0 %}neutral{% endif %}"
              {% if val != 0 %}style="background: {{ rgb }}"{% endif %}>
            <a href="/moneypit/heatmap/transactions?date-key={{ date_key }}&category={{ cat }}">
              {{ "{:,.2f}".format(val) }}
            </a>
          </td>
        {% endfor %}
        <td class="text-right font-semibold pr-4 heatmap-total-cell {% if row_total < 0 %}text-rose-400{% elif row_total > 0 %}text-emerald-400{% else %}text-gray-400{% endif %}">{{ "{:,.2f}".format(row_total) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>

<script>
  (function() {
    const tbody = document.getElementById('heatmap-tbody');
    const header = document.getElementById('heatmap-total-header');
    const indicator = document.getElementById('sort-indicator');
    let ascending = false;

    function sortRows() {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a, b) => {
        const va = parseFloat(a.dataset.total);
        const vb = parseFloat(b.dataset.total);
        return ascending ? vb - va : va - vb;
      });
      rows.forEach(r => tbody.appendChild(r));
      indicator.textContent = ascending ? '↑' : '↓';
    }

    header.addEventListener('click', () => {
      ascending = !ascending;
      sortRows();
    });

    sortRows();
  })();

  (function() {
    const container = document.querySelector('[data-core-expenses]');
    const coreExpenses = container.dataset.coreExpenses === 'Exclude' ? 'Exclude' : '';
    document.querySelectorAll('.date-preset').forEach(btn => {
      btn.addEventListener('click', function() {
        const preset = this.dataset.preset;
        let tsStart, tsEnd;
        if (preset === 'this-year') {
          const y = new Date().getFullYear();
          tsStart = y + '-01';
          tsEnd = (y + 1) + '-01';
        } else {
          const months = parseInt(this.dataset.months, 10);
          const now = new Date();
          const startOffset = (months < 0 && months !== -1) ? months + 1 : months;
          const start = new Date(now.getFullYear(), now.getMonth() + startOffset, 1);
          const end = months === -1
            ? new Date(now.getFullYear(), now.getMonth(), 1)
            : new Date(now.getFullYear(), now.getMonth() + 1, 1);
          const fmt = d => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          tsStart = fmt(start);
          tsEnd = fmt(end);
        }
        const params = new URLSearchParams({ ts_start: tsStart, ts_end: tsEnd });
        if (coreExpenses) params.set('core_expenses', coreExpenses);
        window.location = '/moneypit/heatmap/months?' + params;
      });
    });
  })();
</script>
{% endblock %}
