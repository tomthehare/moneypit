{% extends "base.html" %}

{% block title %}{{ current_file.file_name }}{% endblock %}
{% block page_title %}{{ current_file.source_bank }} — {{ current_file.file_name }}{% endblock %}

{% block header_actions %}
<span class="text-xs text-gray-500 font-mono">{{ current_file.date_created }}</span>
<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold
             bg-gray-800 text-gray-400 border border-gray-700">
  {{ transactions | length }} transactions
</span>
{% set uncategorized_count = transactions | selectattr('category_id', 'none') | list | length %}
{% if uncategorized_count > 0 %}
<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold
             bg-amber-950/60 text-amber-400 border border-amber-800/50">
  {{ uncategorized_count }} uncategorized
</span>
{% endif %}
<a href="/files"
   class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
          border border-gray-700 text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
  <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
  </svg>
  All Files
</a>
{% endblock %}

{% block content %}

<!-- Save status toast (hidden by default) -->
<div id="save-toast"
     class="fixed bottom-5 right-5 z-50 hidden items-center gap-2 px-4 py-2.5 rounded-lg shadow-xl
            text-sm font-medium transition-all">
</div>

<div class="bg-gray-900 rounded-xl border border-gray-800 shadow-lg overflow-hidden">
  <table class="w-full text-sm">
    <thead>
      <tr class="border-b border-gray-800">
        <th class="text-left px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wide w-16">TX ID</th>
        <th class="text-left px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wide">Date</th>
        <th class="text-right px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wide">Amount</th>
        <th class="text-left px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wide">Memo</th>
        <th class="px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wide text-center w-56">Category</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-800">
      {% for tx in transactions %}
      <tr class="transition-colors {% if tx.deleted %}opacity-40{% endif %} hover:bg-gray-800/40 group"
          id="row-{{ tx.tx_id }}">

        <!-- TX ID -->
        <td class="px-4 py-2.5 text-gray-600 font-mono text-xs whitespace-nowrap">
          {{ tx.tx_id }}
        </td>

        <!-- Date -->
        <td class="px-4 py-2.5 text-gray-400 font-mono text-xs whitespace-nowrap">
          {{ tx.date }}
        </td>

        <!-- Amount -->
        <td class="px-4 py-2.5 text-right font-semibold font-mono whitespace-nowrap text-xs
                   {% if tx.denomination < 0 %}text-rose-400{% else %}text-emerald-400{% endif %}">
          {% if tx.denomination < 0 %}-{% endif %}${{ "%.2f" | format(tx.denomination | abs) }}
        </td>

        <!-- Memo -->
        <td class="px-4 py-2.5 text-gray-200 text-xs max-w-xs truncate" title="{{ tx.memo }}">
          {{ tx.memo }}
        </td>

        <!-- Category — inline select, saves on change -->
        <td class="px-4 py-2.5 text-center">
          {% if not tx.deleted %}
          <div class="relative flex items-center gap-2">
            <select data-tx-id="{{ tx.tx_id }}"
                    class="tx-category-select flex-1 bg-gray-800 border text-xs rounded-lg px-2 py-1.5
                           focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent
                           transition-colors cursor-pointer
                           {% if not tx.category_id %}border-amber-700 text-amber-300{% else %}border-gray-700 text-gray-200{% endif %}">
              <option value="" {% if tx.category_id is none %}selected{% endif %}>— uncategorized —</option>
              {% for cat_id, cat_name in categories %}
              <option value="{{ cat_id }}" {% if tx.category_id is not none and cat_id == tx.category_id %}selected{% endif %}>{{ cat_name }}</option>
              {% endfor %}
            </select>
            <!-- Saving spinner (hidden) -->
            <svg class="save-spinner hidden w-3.5 h-3.5 text-brand-400 animate-spin flex-shrink-0"
                 fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
              <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
            </svg>
            <!-- Saved check (hidden) -->
            <svg class="save-check hidden w-3.5 h-3.5 text-brand-400 flex-shrink-0"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
            </svg>
            <!-- Error mark (hidden) -->
            <svg class="save-error hidden w-3.5 h-3.5 text-rose-400 flex-shrink-0"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </div>
          {% else %}
          <span class="text-gray-600 text-xs italic">deleted</span>
          {% endif %}
        </td>

      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}

{% block scripts %}
<script>
  const CATEGORIES = {
    {% for cat_id, cat_name in categories %}
    {{ cat_id }}: {{ cat_name | tojson }}{% if not loop.last %},{% endif %}
    {% endfor %}
  };

  function showToast(message, isError = false) {
    const toast = document.getElementById('save-toast');
    toast.textContent = message;
    toast.className = [
      'fixed bottom-5 right-5 z-50 flex items-center gap-2 px-4 py-2.5 rounded-lg shadow-xl',
      'text-sm font-medium transition-all',
      isError
        ? 'bg-rose-950 border border-rose-800 text-rose-300'
        : 'bg-gray-800 border border-gray-700 text-gray-200'
    ].join(' ');
    toast.classList.remove('hidden');
    clearTimeout(toast._timer);
    toast._timer = setTimeout(() => toast.classList.add('hidden'), 2500);
  }

  function setRowState(row, state) {
    const spinner = row.querySelector('.save-spinner');
    const check   = row.querySelector('.save-check');
    const error   = row.querySelector('.save-error');
    const select  = row.querySelector('.tx-category-select');

    spinner.classList.add('hidden');
    check.classList.add('hidden');
    error.classList.add('hidden');

    if (state === 'saving') {
      spinner.classList.remove('hidden');
      select.disabled = true;
    } else if (state === 'saved') {
      check.classList.remove('hidden');
      select.disabled = false;
      // style the select to reflect categorized state
      select.classList.remove('border-amber-700', 'text-amber-300');
      select.classList.add('border-gray-700', 'text-gray-200');
      setTimeout(() => check.classList.add('hidden'), 2000);
    } else if (state === 'error') {
      error.classList.remove('hidden');
      select.disabled = false;
      setTimeout(() => error.classList.add('hidden'), 3000);
    }
  }

  document.querySelectorAll('.tx-category-select').forEach(select => {
    select.addEventListener('change', async function () {
      const txId = this.dataset.txId;
      const categoryId = this.value;
      const row = document.getElementById('row-' + txId);

      setRowState(row, 'saving');

      try {
        const resp = await fetch(`/api/transaction/${txId}/category`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category_id: categoryId === '' ? null : parseInt(categoryId) }),
        });

        const data = await resp.json();

        if (resp.ok && data.ok) {
          setRowState(row, 'saved');
          const catName = categoryId ? (CATEGORIES[categoryId] || 'unknown') : 'uncategorized';
          showToast(`Saved: ${catName}`);
        } else {
          throw new Error(data.error || 'Server error');
        }
      } catch (err) {
        setRowState(row, 'error');
        showToast('Failed to save — ' + err.message, true);
      }
    });
  });
</script>
{% endblock %}
